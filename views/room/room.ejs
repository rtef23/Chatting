<html>
	<head>
		<% include ../Headers/header_main %>
		<% include ../scripts/date %>
		<style>
			div.borderless{
				border-top:none;
			}
		</style>
	</head>
	<body>
		<div style='width:100%;height:97%;background-color:#80bdff;'>
			<div style='width:70%;height:100%;float:left;'>
				<div id='chat-panel' style='height:65%;width:100%;'>
					<div class='list-group' id='chat-log' style='height:90%;width:90%;overflow-y:scroll;background-color:white;margin-left:5%;margin-top:5%;'>
					</div>
				</div>
				<div class='form-inline' style='margin-top:2.5%;height:30%;text-align:center;'>
					<textarea class='form-control' id='msg-input' style='overflow-y:scroll;width:80%;height:80%;'></textarea>
					<button type='button' class='btn btn-success btn-md' onclick='javascript:sendMsg();'>
						Send
					</button>
				</div>
			</div>
			<div style='width:30%;height:100%;float:left;background-color:#0066ff;'>
				<div id='room-info-panel' style='height:80%;'>
					<div id='room-meta-info' style='height:20%;width:100%;background-color:#cce6ff;'>
						<table class='table'>
							<tr>
								<td colspan='2'>
								<span id='user-id' class='label label-default'>
								</span>
								</td>
							</tr>
							<tr>
								<td>
									<span class='label label-info'>
									# of User
									</span>
								</td>
								<td>
									<span id='num-of-user' class='label label-success'>
									</span>
								</td>
							</tr>
						</table>
					</div>
					<div id='connected-user-list' class='list-group' style='width=100%;height:80%;overflow-y:scroll;background-color:white;'>
					</div>
				</div>
				<div id='room-interface' class='form-inline' style='height:20%;'>
					<button class='btn btn-sm btn-info form-control'>
						Leave Room
					</button>
					<button class='btn btn-sm btn-info form-control'>
						Close Room
					</button>
					<button class='btn btn-sm btn-info form-control'>
						Invite User
					</button>
				</div>
			</div>
		</div>
	</body>
</html>
<div id='message-form' style='display:none;'>
	<div class='list-group-item form-inline borderless' style='width:100%;background-color:%color%;'>
		<h4>
			<span class='label label-info'>
			%user_label%
			</span>
		</h4>
		<div id='msg' style='text-align:center;'>
			%text%
		</div>
		<div style='text-align:right;'>
			<span class='badge'>
				%time_stamp%
			</span>
		</div>
	</div>
</div>
<div id='friend-list-item-form' style='display:none;'>
	<div class='list-group' id='%member_id%'>
		<span class='label label-%member_state%'>
			%member_state_text%
		</span>
		%member_nick%
	</div>
</div>
<div id='not-friend-list-item-form' style='display:none;'>
	<div class='list-group' id='%member_id%'>
		<span class='badge'>
			Not Friend
		</span>
		%member_id%
	</div>
</div>

<script>
var color_index = 0;
var opener;

$(function(){
	opener = window.opener;
	$(window).on("beforeunload", function(){
		opener.closeChildWindow("<%=room_id %>");
	});
	opener.requestChatLog('<%=room_id %>');
	updateChattingWindow(getChattingData());
});
var getChattingData = function(){
	var room_info = opener.user.get('rooms').get('<%=room_id %>');
	var friends = opener.user.get('friends');
	var res = {
		members : []
	};

	for(var i in room_info.members){
		if(friends.containsKey(room_info.members[i].user_id)){
			res.members.push({
				isfriend : true,
				member_id : room_info.members[i].user_id,
				member_nick : friends.get(room_info.members[i].user_id).friend_nick,
				isonline : friends.get(room_info.members[i].user_id).isOnline
			});
		}else{
			res.members.push({
				isfriend : false,
				member_id : room_info.members[i].user_id
			});
		}
	}
	alert(JSON.stringify(res));
	return res;
};
var updateChattingWindow = function(data){
	/*
	input
	{
		members : [
			{
				isfriend : d1[true|false],
				member_id : d2, 
				iff isfriend == true
					member_nick : d3,
					isonline : d4[true|false]
			},...
		]
	}
	*/
	//alert(JSON.stringify(data));
	$('span#user-id').text(opener.user.get('user_id'));
	$('span[id=num-of-user]').text(data.members.length);
	for(var i in data.members){
		if(data.members[i].isfriend){
			addFriendMember();
		}else{
			//data.members[i].isfriend == false
			addNotFriendMember();
		}
	}
};
var addFriendMember = function(data){
	/*
	data
	{
		member_id : d1,
		member_nick : d2,
		isonline : d3
	}
	*/
	var form = $('div#friend-list-item-form').html();
	
	form = form.replace(/%member_id%/g, data.member_id);
	form = form.replace(/%member_nick%/g, data.member_nick);
	if(data.isonline){
		form = form.replace(/%member_state%/g, 'success');
		form = form.replace(/%member_state_text%/g, 'Online');
	}else{
		form = form.replace(/%member_state%/g, 'danger');
		form = form.replace(/%member_state_text%/g, 'Offline');
	}

	$('div#connected-user-list').append(form);
};
var addNotFriendMember = function(data){
	/*
	data
	{
		member_id : d1
	}
	*/
	var form = $('div#not-friend-list-item-form').html();

	form = form.replace(/%member_id%/g, data.member_id);

	$('div#connected-user-list').append(form);
};

var addMessage = function(data){
	/*
	form
	{
		user_info : d1,
		msg : d2,
		time_stamp : d3
	}
	*/
	var form = $('div#message-form').html();

	form = form.replace(/%user_label%/g, data.user_info);	
	form = form.replace(/%text%/g, data.msg.replace('\n', '<br>'));
	form = form.replace(/%time_stamp%/g, data.time_stamp);
	form = form.replace(/%color%/g, getColor(color_index));

	color_index = (color_index + 1) % 3;

	$('div#chat-log').append(form);

	var scroll_obj = $('div#chat-log');
	scroll_obj.scrollTop(scroll_obj[0].scrollHeight);
};
var getColor = function(color_index){
	switch(color_index){
		case 0:
			return '#e6f2ff';
		case 1:
			return '#cce5ff';
		default:
			return '#b3d7ff';
	}
};

var sendMsg = function(){
	//alert(getCurTime());
	var data = {
		msg : $('textarea#msg-input').val(),
		room_id : '<%=room_id %>',
		time_stamp : getCurTime()
	};
	$('textarea#msg-input').val('');

	opener.sendMsg(data);
};
var getCurTime = function(){
	return new Date().format('yyyy-MM-dd HH:mm:ss');
};

</script>